<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WaveFunctionCollapse</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet" type="text/css" />
  <!-- Three.js CDN with fallback -->
  <script>
    // Fallback system for Three.js loading
    window.threeJSLoaded = false;
    window.threeJSLoadAttempts = 0;
    window.maxThreeJSLoadAttempts = 3;

    function loadThreeJS() {
      window.threeJSLoadAttempts++;

      // Clear any existing script
      const existingScript = document.querySelector('script[src*="three.min.js"]');
      if (existingScript) {
        existingScript.remove();
      }

      const script = document.createElement('script');

      // Try different CDN sources
      const cdnUrls = [
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js',
        'https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js',
        'https://unpkg.com/three@0.152.0/build/three.min.js'
      ];

      script.src = cdnUrls[(window.threeJSLoadAttempts - 1) % cdnUrls.length];

      script.onload = function() {
        if (typeof window.THREE !== 'undefined') {
          window.threeJSLoaded = true;
          console.log('‚úÖ Three.js loaded successfully from:', script.src);
          console.log('Three.js version:', window.THREE.REVISION);

          // Configure SystemJS
          if (typeof System !== 'undefined' && typeof System.set === 'function') {
            System.set('three', System.newModule(window.THREE));
          }

          console.log('üöÄ Starting main application load sequence...');
          // Load the main application
          loadMainApplication();
        } else {
          console.error('‚ùå Three.js loaded but THREE object not found');
          tryNextCDN();
        }
      };

      script.onerror = function() {
        console.error('‚ùå Failed to load Three.js from:', script.src);
        tryNextCDN();
      };

      document.head.appendChild(script);
    }

    function tryNextCDN() {
      if (window.threeJSLoadAttempts < window.maxThreeJSLoadAttempts) {
        console.log(`üîÑ Trying next CDN (attempt ${window.threeJSLoadAttempts + 1}/${window.maxThreeJSLoadAttempts})`);
        setTimeout(loadThreeJS, 1000);
      } else {
        console.error('‚ùå All Three.js CDN attempts failed');
        showFallbackMessage();
      }
    }

    function loadMainApplication() {
      // First load SystemJS
      if (typeof System === 'undefined') {
        const systemJSScript = document.createElement('script');
        systemJSScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/systemjs/0.20.19/system.js';
        systemJSScript.onload = function() {
          console.log('‚úÖ SystemJS loaded');
          console.log('üîß Configuring SystemJS for Three.js...');
          if (typeof System !== 'undefined' && typeof System.set === 'function') {
            System.set('three', System.newModule(window.THREE));
            console.log('‚úÖ SystemJS configured for Three.js');
          } else {
            console.warn('SystemJS global not found as System; proceeding without mapping.');
          }

          // Now load our compiled TypeScript
          loadDistJS();
        };
        systemJSScript.onerror = function() {
          console.error('‚ùå Failed to load SystemJS');
        };
        document.head.appendChild(systemJSScript);
      } else {
        if (typeof System.set === 'function') {
          System.set('three', System.newModule(window.THREE));
        }
        loadDistJS();
      }
    }

    function loadDistJS() {
      console.log('üì¶ Loading dist.js...');

      // Use a timeout to ensure SystemJS is fully initialized
      setTimeout(function() {
        // Load dist.js (contains our compiled TypeScript)
        const distScript = document.createElement('script');
        distScript.src = 'dist.js?v=' + Date.now();
        distScript.onload = function() {
          console.log('‚úÖ Application (dist.js) loaded successfully');
          console.log('üéØ Starting main module import...');

          // Give SystemJS a moment to process the loaded modules
          setTimeout(function() {
            if (typeof System !== 'undefined' && typeof System.import === 'function') {
              console.log('‚úÖ SystemJS is available, importing main module...');

              // Try to import the main module
              System.import("main").then(function(module) {
                console.log('‚úÖ Main module loaded successfully!');
                console.log('üéÆ Application should now be running...');
              }).catch(function(err) {
                console.error('‚ùå Failed to load main module:', err);
                if (err.message) console.error('Error message:', err.message);
                if (err.stack) console.error('Stack trace:', err.stack);
              });
            } else {
              console.error('‚ùå SystemJS is not available after loading dist.js');
            }
          }, 100); // Small delay to ensure SystemJS processes the modules
        };
        distScript.onerror = function() {
          console.error('‚ùå Failed to load dist.js from server');
        };

        console.log('üîó Adding dist.js to document...');
        document.head.appendChild(distScript);
      }, 200); // Delay to ensure SystemJS is fully ready
    }

    function showFallbackMessage() {
      document.body.innerHTML = `
        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
          <h1>‚ö†Ô∏è Three.js Loading Failed</h1>
          <p>Unable to load Three.js from CDN sources.</p>
          <p>Please check your internet connection and try:</p>
          <ul style="text-align: left; display: inline-block;">
            <li>Refresh the page (F5)</li>
            <li>Clear browser cache</li>
            <li>Disable ad blockers temporarily</li>
            <li>Try a different browser</li>
          </ul>
          <p><small>If the problem persists, the 2D version should still work.</small></p>
          <p><button onclick="window.location.reload()">üîÑ Retry Loading</button></p>
        </div>
      `;
    }

    // Start loading Three.js
    loadThreeJS();
  </script>
</head>

<body>
  <header class="app-header">
    <div class="container d-flex align-items-center justify-content-between py-3">
      <div class="d-flex align-items-center gap-3">
        <div class="brand-mark" aria-hidden="true"></div>
        <h1 class="app-title m-0">Wave Function Collapse</h1>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="themeToggle" class="btn btn-sm" type="button" title="Toggle theme">Toggle theme</button>
      </div>
    </div>
  </header>
  <main class="container py-3"></main>
  <footer class="app-footer">
    <div class="container py-4 d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <p class="m-0 small text-muted">By Lucas Crane (<a href="https://github.com/jaxry">Github</a>, <a href="https://github.com/jaxry/wave-function-collapse">Source</a>)</p>
      <p class="m-0 small text-muted">UI refresh by modern theme</p>
    </div>
  </footer>

  <script>
    (function() {
      const storageKey = 'theme-preference';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem(storageKey);
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      const btn = document.getElementById('themeToggle');
      if (btn) {
        btn.addEventListener('click', function () {
          const current = document.documentElement.getAttribute('data-theme') || 'dark';
          const next = current === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem(storageKey, next);
        });
      }
    })();
  </script>
</body>
</html>
